<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/buildfarm/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/buildfarm/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/buildfarm/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/buildfarm/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Queues | Buildfarm</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Queues" /><meta property="og:locale" content="en_US" /><meta name="description" content="Remote Caching and Execution" /><meta property="og:description" content="Remote Caching and Execution" /><link rel="canonical" href="https://buildfarm.github.io/buildfarm/docs/architecture/queues/" /><meta property="og:url" content="https://buildfarm.github.io/buildfarm/docs/architecture/queues/" /><meta property="og:site_name" content="Buildfarm" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Queues" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Remote Caching and Execution","headline":"Queues","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://buildfarm.github.io/buildfarm/assets/images/buildfarm-logo.png"}},"url":"https://buildfarm.github.io/buildfarm/docs/architecture/queues/"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="https://buildfarm.github.io/buildfarm/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/features/" class="nav-list-link">Features</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/quick_start/" class="nav-list-link">Quick Start</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/configuration/configuration/" class="nav-list-link">Configuration</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/configuration/authentication/" class="nav-list-link">Authentication</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/" class="nav-list-link">Architecture</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/instance_types/" class="nav-list-link">Instance Types</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/workers/" class="nav-list-link">Workers</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/schedulers/" class="nav-list-link">Schedulers</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/" class="nav-list-link">Worker Execution Environment</a><li class="nav-list-item active"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/queues/" class="nav-list-link active">Queues</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/action_cache/" class="nav-list-link">Action Cache</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/CASFileCache/" class="nav-list-link">CASFileCache</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/" class="nav-list-link">CAS</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/redis/" class="nav-list-link">Redis</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution/" class="nav-list-link">Execution</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/debugging-executions/" class="nav-list-link">Debugging</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/environment/" class="nav-list-link">Environment</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/exec_owner/" class="nav-list-link">Owner</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_limiting/" class="nav-list-link">Limiting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/builds-without-the-bytes/" class="nav-list-link">Build Without Bytes</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_properties/" class="nav-list-link">Properties</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_policies/" class="nav-list-link">Policies</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/observability/" class="nav-list-link">Observability</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/metrics/metrics/" class="nav-list-link">Metrics</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/metrics/alerts/" class="nav-list-link">Alerts</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/tools/tools/" class="nav-list-link">Tools</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/troubleshooting-bazel-remote-execution/" class="nav-list-link">Troubleshooting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/bf-cat/" class="nav-list-link">bf-cat</a></ul><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/admin/" class="nav-list-link">Admin</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/contribute/contribute/" class="nav-list-link">Contribute</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/local_development/" class="nav-list-link">Local Development</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/design-documents/" class="nav-list-link">Design Documents</a></ul></ul></nav><footer class="site-footer"></footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Buildfarm" aria-label="Search Buildfarm" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/buildfarm/buildfarm" class="site-button" > GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/">Architecture</a><li class="breadcrumb-nav-list-item"><span>Queues</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="operation-queue"> <a href="#operation-queue" class="anchor-heading" aria-labelledby="operation-queue"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Operation Queue</h1><p>This section discusses the purpose and design of the Operation queue. It also discusses how it can be customized depending on the type of operations you wish to support, and how you wish to distribute them among workers.</p><h2 id="quick-summary"> <a href="#quick-summary" class="anchor-heading" aria-labelledby="quick-summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Quick Summary</h2><p>Some time after an Action execute request occurs, the longrunning operation it corresponds to will enter the QUEUED state, and will receive an update to that effect on the operation response stream. An operation in the QUEUED state is present in an Operation Queue, which holds the operations in sequence until a worker is available to execute it.</p><p>Schedulers put operations on the queue. Workers take them off. <img src="https://buildfarm.github.io/buildfarm/assets/images/Operation-Queue1.png" alt="Operation Queue" /></p><h2 id="working-with-different-platform-requirements"> <a href="#working-with-different-platform-requirements" class="anchor-heading" aria-labelledby="working-with-different-platform-requirements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Working with different platform requirements</h2><p>Some operations’ Actions may have specific platform requirements in order to execute. Likewise, specific workers may only want to take on work that they deem eligible. To solve this, the operation queue can be customized to divide work into separate provisioned queues so that specific workers can choose which queue to read from.</p><p>Provision queues are intended to represent particular operations that should only be processed by particular workers. An example use case for this would be to have two dedicated provision queues for CPU and GPU operations. CPU/GPU requirements would be determined through the <a href="https://github.com/bazelbuild/remote-apis/blob/main/build/bazel/remote/execution/v2/remote_execution.proto#L595">remote api’s command platform properties</a>. We designate provision queues to have a set of “required provisions” (which match the platform properties). This allows the scheduler to distribute operations by their properties and allows workers to dequeue from particular queues.</p><p>If your configuration file does not specify any provisioned queues, buildfarm will automatically provide a default queue with full eligibility on all operations. This will ensure the expected behavior for the paradigm in which all work is put on the same queue.</p><h3 id="matching-algorithm"> <a href="#matching-algorithm" class="anchor-heading" aria-labelledby="matching-algorithm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Matching Algorithm</h3><p>The matching algorithm is performed by the operation queue when the server or worker is requesting to push or pop elements, respectively. The matching algorithm is designed to find the appropriate queue to perform these actions on. On the scheduler side, the action’s platform properties are used for matching. On the worker side, the <code class="language-plaintext highlighter-rouge">dequeue_match_settings</code> are used. <img src="https://buildfarm.github.io/buildfarm/assets/images/Operation-Queue-Matching1.png" alt="Operation Queue Matching" /></p><p>The matching algorithm works as follows: Each provision queue is checked in the order that it is configured. The first provision queue that is deemed eligible is chosen and used. When deciding if an action is eligible for the provision queue, each platform property is checked individually. By default, there must be a perfect match on each key/value. Wildcards (“*”) can be used to avoid the need of a perfect match. Additionally, if the action contains any platform properties is not mentioned by the provision queue, it will be deemed ineligible. setting <code class="language-plaintext highlighter-rouge">allowUnmatched: true</code> can be used to allow a superset of action properties as long as a subset matches the provision queue. If no provision queues can be matched, the operation queue will provide an analysis on why none of the queues were eligible.</p><p>A worker will dequeue operations from matching queues and determine whether to keep and execute it according to the following procedure: For each property key-value in the operation’s platform, an operation is REJECTED if: The key is <code class="language-plaintext highlighter-rouge">min-cores</code> and the integer value is greater than the number of cores on the worker. Or The key is <code class="language-plaintext highlighter-rouge">min-mem</code> and the integer value is greater than the number of bytes of RAM on the worker. Or if the key exists in the <code class="language-plaintext highlighter-rouge">DequeueMatchSettings</code> platform with neither the value nor a <code class="language-plaintext highlighter-rouge">*</code> in the corresponding DMS platform key’s values, Or if the <code class="language-plaintext highlighter-rouge">allowUnmatched</code> setting is <code class="language-plaintext highlighter-rouge">false</code>. For each resource requested in the operation’s platform with the resource: prefix, the action is rejected if: The resource amount cannot currently be satisfied with the associated resource capacity count</p><p>There are special predefined execution property names which resolve to dynamic configuration for the worker to match against: <code class="language-plaintext highlighter-rouge">Worker</code>: The worker’s <code class="language-plaintext highlighter-rouge">publicName</code> <code class="language-plaintext highlighter-rouge">min-cores</code>: Less than or equal to the <code class="language-plaintext highlighter-rouge">executeStageWidth</code> <code class="language-plaintext highlighter-rouge">process-wrapper</code>: The set of named <code class="language-plaintext highlighter-rouge">process-wrappers</code> present in configuration</p><h3 id="server-example"> <a href="#server-example" class="anchor-heading" aria-labelledby="server-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Server Example</h3><p>In this example the scheduler declares a GPU queue and CPU queue. All queues must be declared for the server deployment:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backplane:
  queues:
    - name: "cpu"
      allowUnmatched: true
      properties:
        - name: "min-cores"
          value: "*"
        - name: "max-cores"
          value: "*"
    - name: "gpu"
      allowUnmatched: true
      properties:
        - name: "gpu"
          value: "1"
</code></pre></div></div><h3 id="worker-example"> <a href="#worker-example" class="anchor-heading" aria-labelledby="worker-example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Worker Example</h3><p>Queues are defined similarly on Workers. Only the specific worker type queue must be declared for that specific worker deployment.</p><p>For example, for a CPU worker pool use:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backplane:
  queues:
    - name: "cpu"
      allowUnmatched: true
      properties:
        - name: "min-cores"
          value: "*"
        - name: "max-cores"
          value: "*"
</code></pre></div></div><p>For example, for a GPU worker pool use:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>backplane:
  queues:
    - name: "gpu"
      allowUnmatched: true
      properties:
        - name: "gpu"
          value: "1"
</code></pre></div></div><p>Note: make sure that all workers can communicate with each other before trying these examples</p><h3 id="bazel-perspective"> <a href="#bazel-perspective" class="anchor-heading" aria-labelledby="bazel-perspective"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Bazel Perspective</h3><p>Bazel targets can pass these platform properties to buildfarm via <a href="https://docs.bazel.build/versions/master/be/common-definitions.html#common.exec_properties">exec_properties</a>. Here is for example how to run a remote build for the GPU queue example above:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel build <span class="nt">--remote_executor</span><span class="o">=</span>grpc://server:port <span class="nt">--remote_default_exec_properties</span><span class="o">=</span><span class="nv">gpu</span><span class="o">=</span>1 //...
</code></pre></div></div><hr><footer><p class="text-small text-grey-dk-100 mb-0"></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/buildfarm/buildfarm/edit/main/_site/docs/architecture/queues.md" id="edit-this-page">Edit on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
