<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/buildfarm/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/buildfarm/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/buildfarm/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/buildfarm/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>CAS | Buildfarm</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="CAS" /><meta property="og:locale" content="en_US" /><meta name="description" content="Remote Caching and Execution" /><meta property="og:description" content="Remote Caching and Execution" /><link rel="canonical" href="https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/" /><meta property="og:url" content="https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/" /><meta property="og:site_name" content="Buildfarm" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CAS" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Remote Caching and Execution","headline":"CAS","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://buildfarm.github.io/buildfarm/assets/images/buildfarm-logo.png"}},"url":"https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="https://buildfarm.github.io/buildfarm/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/features/" class="nav-list-link">Features</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/quick_start/" class="nav-list-link">Quick Start</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/configuration/configuration/" class="nav-list-link">Configuration</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/configuration/authentication/" class="nav-list-link">Authentication</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/" class="nav-list-link">Architecture</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/instance_types/" class="nav-list-link">Instance Types</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/workers/" class="nav-list-link">Workers</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/schedulers/" class="nav-list-link">Schedulers</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/" class="nav-list-link">Worker Execution Environment</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/queues/" class="nav-list-link">Queues</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/action_cache/" class="nav-list-link">Action Cache</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/CASFileCache/" class="nav-list-link">CASFileCache</a><li class="nav-list-item active"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/" class="nav-list-link active">CAS</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/redis/" class="nav-list-link">Redis</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution/" class="nav-list-link">Execution</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/debugging-executions/" class="nav-list-link">Debugging</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/environment/" class="nav-list-link">Environment</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/exec_owner/" class="nav-list-link">Owner</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_limiting/" class="nav-list-link">Limiting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/builds-without-the-bytes/" class="nav-list-link">Build Without Bytes</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_properties/" class="nav-list-link">Properties</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_policies/" class="nav-list-link">Policies</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/observability/" class="nav-list-link">Observability</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/metrics/metrics/" class="nav-list-link">Metrics</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/metrics/alerts/" class="nav-list-link">Alerts</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/tools/tools/" class="nav-list-link">Tools</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/troubleshooting-bazel-remote-execution/" class="nav-list-link">Troubleshooting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/bf-cat/" class="nav-list-link">bf-cat</a></ul><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/admin/" class="nav-list-link">Admin</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/contribute/contribute/" class="nav-list-link">Contribute</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/local_development/" class="nav-list-link">Local Development</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/design-documents/" class="nav-list-link">Design Documents</a></ul></ul></nav><footer class="site-footer"></footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Buildfarm" aria-label="Search Buildfarm" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/buildfarm/buildfarm" class="site-button" > GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/">Architecture</a><li class="breadcrumb-nav-list-item"><span>CAS</span></ol></nav><div id="main-content" class="main-content" role="main"><p>A Content Addressable Storage (CAS) is a collection of service endpoints which provide read and creation access to immutable binary large objects (blobs). The core service is declared in the <a href="https://github.com/bazelbuild/remote-apis">Remote Execution API</a>, and also requires presentation of the <a href="https://github.com/googleapis/googleapis/blob/master/google/bytestream/bytestream.proto">ByteStream API</a> with specializations for resource names and behaviors.</p><p>An entry in the CAS is a sequence of bytes whose computed digest via a hashing function constitutes its address. The address is specified as either a [Digest] message, or by the makeup of a resource name in ByteStream requests.</p><p>A CAS supports several methods of retrieving and inserting entries, as well as some utility methods for determining presence and iterating through linked hierarchies of directories as Merkle Trees.</p><p>Functionally within the REAPI, the CAS is the communication plane for Action inputs and outputs, and is used to retain other contents by existing clients, including bazel, like build event information.</p><h1 id="methods"> <a href="#methods" class="anchor-heading" aria-labelledby="methods"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Methods</h1><h2 id="reads"> <a href="#reads" class="anchor-heading" aria-labelledby="reads"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Reads</h2><p>A read of content from a CAS is a relatively simple procedure, whether accessed through BatchReadBlobs, or the ByteStream Read method. The semantics associated with these requests require the support of content availability translation (NOT_FOUND for missing), and seeking to a particular offset to start reading. Clients are expected to behave progressively, since no size limitation nor bandwidth availability is mandated, meaning that they should advance an offset along the length of the content until complete with successive requests, assuming DEADLINE_EXCEEDED or other transient errors occur during the download. <code class="language-plaintext highlighter-rouge">resource_name</code> for reads within ByteStream Read must be <code class="language-plaintext highlighter-rouge">"{instance_name}/blobs/{hash}/{size}"</code></p><h2 id="writes"> <a href="#writes" class="anchor-heading" aria-labelledby="writes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writes</h2><p>Writes of content into a CAS require a prior computation of an address with a digest method of choice for all content. A write can be initiated with BatchUpdateBlobs or the ByteStream Write method. A ByteStream Write <code class="language-plaintext highlighter-rouge">resource_name</code> must begin with <code class="language-plaintext highlighter-rouge">{instance_name}/uploads/{uuid}/blobs/{hash}/{size}</code>, and may have any trailing filename after the size, separated by ‘/’. The trailing content is ignored. The <code class="language-plaintext highlighter-rouge">uuid</code> is a client generated identifier for a given write, and may be shared among many digests, but should be strictly client-local. Writes should respect a WriteResponse received at any time after initiating the request of the size of the blob, to indicate that no further WriteRequests are necessary. Writes which fail prior to the receipt of content should be progressive, checking for the offset to resume an upload via ByteStream QueryWriteStatus.</p><p>Buildfarm implements the CAS in a variety of ways, including an in-memory storage for the reference implementation, as a proxy for an external CAS, an HTTP/1 proxy based on the remote-cache implementation in bazel, and as a persistent on-disk storage for workers, supplementing an execution filesystem for actions as well as participating in a sparsely-sharded distributed store.</p><h1 id="buildfarm-implementations"> <a href="#buildfarm-implementations" class="anchor-heading" aria-labelledby="buildfarm-implementations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Buildfarm Implementations</h1><p>Since these implementations vary in complexity and storage semantics, a common interface was declared within Buildfarm to accommodate substitutions of a CAS, as well as standardize its use. The specifics of these CAS implementations are detailed here.</p><h2 id="memory"> <a href="#memory" class="anchor-heading" aria-labelledby="memory"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Memory</h2><p>The memory CAS implementation is extremely simple in design, constituting a maximum size with LRU eviction policy. Entry eviction is a registrable event for use as a storage for the delegated ActionCache, and Writes may be completed asynchronously by concurrent independent upload completion of an entry.</p><p>This is the example presentation of a CAS in the memory instance available <a href="https://github.com/buildfarm/buildfarm/blob/main/examples/config.yml">here</a>, but for reference, specification in any <code class="language-plaintext highlighter-rouge">cas_config</code> field for server or worker will enable the creation of a unique instance.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker:
  storages:
    - type: MEMORY
      maxSizeBytes: 2147483648 # 2 * 1024 * 1024 * 1024
</code></pre></div></div><h2 id="grpc"> <a href="#grpc" class="anchor-heading" aria-labelledby="grpc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> GRPC</h2><p>This is a CAS which completely mirrors a target CAS for all requests, useful as a proxy to be embedded in a full Instance declaration.</p><p>A grpc config example is available in the alternate instance specification in the memory server example <a href="https://github.com/buildfarm/buildfarm/blob/main/examples/config.yml">here</a>. For reference:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server:
  name: shard
worker:
  storages:
    - type: FILESYSTEM
      path: "cache"
    - type: GRPC
      target:
</code></pre></div></div><h2 id="http1"> <a href="#http1" class="anchor-heading" aria-labelledby="http1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> HTTP/1</h2><p>The HTTP/1 CAS proxy hosts a GRPC service definition for a configurable target HTTP/1 service that it communicates with using an identical implementation to the <a href="https://github.com/bazelbuild/bazel/tree/master/src/main/java/com/google/devtools/build/lib/remote/http">bazel http remote cache protocol</a>.</p><p>Since the HTTP/1 proxy is a separate process, there are no configuration options for it. Instead, run the proxy in a known location (address and port), and use a grpc configuration indicated above, pointing to its address and instance name. The proxy can be run with:</p><p><code class="language-plaintext highlighter-rouge">bazel run src/main/java/build/buildfarm/tools:buildfarm-http-proxy -- -p 8081 -c "http://your-http-endpoint" --noreadonly</code></p><p>And will result in a listening grpc service on port 8081 on all interfaces, relaying requests to the endpoint in question. Use <code class="language-plaintext highlighter-rouge">--help</code> to see more options.</p><h2 id="shard"> <a href="#shard" class="anchor-heading" aria-labelledby="shard"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Shard</h2><p>A sharded CAS leverages multiple Worker CAS retention and proxies requests to hosts with isolated CAS shards. These shards register their participation and entry presentation on a ShardBackplane. The backplane maintains a mapping of addresses to the nodes which host them. The sharded CAS is an aggregated proxy for its members, performing each function with fallback as appropriate; FindMissingBlobs requests are cycled through the shards, reducing a list of missing entries, Writes select a target node at random, Reads attempt a request on each advertised shard for an entry with failover on NOT_FOUND or transient grpc error. Reads are optimistic, given that a blob would not be requested that was not expected to be found, the sharded CAS will failover on complete absence of a blob to a whole cluster search for an entry.</p><p>A shard CAS is the default for the Shard Instance type, with its required <a href="https://github.com/buildfarm/buildfarm/blob/main/examples/config.minimal.yml">backplane specification</a>. Since functionality between Shard CAS, AC, and Execution are mixed in here, the definition is somewhat cluttered, with efforts to refine specific aspects of it underway.</p><h2 id="worker-cas"> <a href="#worker-cas" class="anchor-heading" aria-labelledby="worker-cas"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Worker CAS</h2><p>Working hand in hand with the Shard CAS implementation, the Worker CAS leverages a requisite on-disk store to provide a CAS from its CASFileCache. Since the worker maintains a large cache of inputs for use with actions, this CAS is routinely populated from downloads due to operation input fetches in addition to uploads from the Shard frontend.</p><h3 id="casfilecache"> <a href="#casfilecache" class="anchor-heading" aria-labelledby="casfilecache"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> CasFileCache</h3><p>The worker’s CAS file cache uses persistent disk storage. A strongly recommended filesystem to back this is XFS, due to its high link counts limits per inode. A strongly discouraged filesystem is ext4, which places a hard limit of 65000 link counts per inode. The layout of the files are ordered such that file content, in the form of canonical digest filenames for inode storage, remains on the root of the cache directory, while exec roots and symlinkable directories contain hard links to these inodes. This avoids unnecessary duplication of file contents.</p><p>Upon worker startup, the worker’s cache instance is initialized in two phases. First, the root is scanned to store file information. Second, the existing directories are traversed to compute their validating identification. Files will be automatically deleted if their file names are invalid for the cache, or if the configured cache size has been exceeded by previous files.</p><p>The shard worker allows a flexible specification, with delegates available of the other types to fall back on for CAS expansion, and <a href="https://github.com/buildfarm/buildfarm/blob/main/examples/config.yml">encapsulated CAS configs</a></p><p>CASTest is a standalone tool to load the cache and print status information about it.</p><hr><footer><p class="text-small text-grey-dk-100 mb-0"></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/buildfarm/buildfarm/edit/main/_site/docs/architecture/content_addressable_storage.md" id="edit-this-page">Edit on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
