<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/buildfarm/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/buildfarm/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/buildfarm/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/buildfarm/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Worker Execution Environment | Buildfarm</title><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="Worker Execution Environment" /><meta property="og:locale" content="en_US" /><meta name="description" content="Remote Caching and Execution" /><meta property="og:description" content="Remote Caching and Execution" /><link rel="canonical" href="https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/" /><meta property="og:url" content="https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/" /><meta property="og:site_name" content="Buildfarm" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Worker Execution Environment" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Remote Caching and Execution","headline":"Worker Execution Environment","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://buildfarm.github.io/buildfarm/assets/images/buildfarm-logo.png"}},"url":"https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="https://buildfarm.github.io/buildfarm/" class="site-title lh-tight"><div class="site-logo"></div></a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/features/" class="nav-list-link">Features</a><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/quick_start/" class="nav-list-link">Quick Start</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/configuration/configuration/" class="nav-list-link">Configuration</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/configuration/authentication/" class="nav-list-link">Authentication</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/" class="nav-list-link">Architecture</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/instance_types/" class="nav-list-link">Instance Types</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/workers/" class="nav-list-link">Workers</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/schedulers/" class="nav-list-link">Schedulers</a><li class="nav-list-item active"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/worker-execution-environment/" class="nav-list-link active">Worker Execution Environment</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/queues/" class="nav-list-link">Queues</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/action_cache/" class="nav-list-link">Action Cache</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/CASFileCache/" class="nav-list-link">CASFileCache</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/content_addressable_storage/" class="nav-list-link">CAS</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/architecture/redis/" class="nav-list-link">Redis</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution/" class="nav-list-link">Execution</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/debugging-executions/" class="nav-list-link">Debugging</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/environment/" class="nav-list-link">Environment</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/exec_owner/" class="nav-list-link">Owner</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_limiting/" class="nav-list-link">Limiting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/builds-without-the-bytes/" class="nav-list-link">Build Without Bytes</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_properties/" class="nav-list-link">Properties</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/execution_policies/" class="nav-list-link">Policies</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/execution/observability/" class="nav-list-link">Observability</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/metrics/metrics/" class="nav-list-link">Metrics</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/metrics/alerts/" class="nav-list-link">Alerts</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/tools/tools/" class="nav-list-link">Tools</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/troubleshooting-bazel-remote-execution/" class="nav-list-link">Troubleshooting</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/tools/bf-cat/" class="nav-list-link">bf-cat</a></ul><li class="nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/admin/" class="nav-list-link">Admin</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://buildfarm.github.io/buildfarm/docs/contribute/contribute/" class="nav-list-link">Contribute</a><ul class="nav-list "><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/local_development/" class="nav-list-link">Local Development</a><li class="nav-list-item "><a href="https://buildfarm.github.io/buildfarm/docs/contribute/design-documents/" class="nav-list-link">Design Documents</a></ul></ul></nav><footer class="site-footer"></footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Buildfarm" aria-label="Search Buildfarm" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/buildfarm/buildfarm" class="site-button" > GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://buildfarm.github.io/buildfarm/docs/architecture/architecture/">Architecture</a><li class="breadcrumb-nav-list-item"><span>Worker Execution Environment</span></ol></nav><div id="main-content" class="main-content" role="main"><p>Since workers are expected to execute programs in a way that makes using remote transparent to build users, there is a great deal of nuance to their definition. Operating System, Distribution, runtimes, compilers, their versions, and standard libraries make this a tricky proposition. While hermeticizing a build by declaring the full set of tools a compilation requires is the ‘right’ solution for a build, it may be too big of a hill to climb for everyone, particularly those trying to ease into remote execution.</p><p>Under Linux at least, this is made somewhat easier through docker, even if the steps to get to a conformant environment are a bit complicated. Here we will provide an example of creating a target execution environment container capable of running buildfarm, and this should be similar for all major distributions, particularly those with released docker hub bases and standard package managers including java runtimes and toolchain software. You should choose the versions of relevant software at first based on the client environment you want to support.</p><p>For this example, we’re going to assume a target of ubuntu-20 (focal), with a gcc9 compiler supporting C++, and a java runtime from openjdk-14 supplied by its package manager. We will need:</p><ul><li>a bazel 3.3.1 install (the older version is required by rules_docker at the buildfarm version, this will be updated eventually).<li>docker daemon running</ul><p>First we will pull our intended base image from dockerhub:</p><p><code class="language-plaintext highlighter-rouge">docker pull ubuntu:focal</code></p><p>Next we will create our Dockerfile for our customized environment. Here is the content of that Dockerfile</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># choose our ubuntu distribution with version 20 (focal)
from ubuntu:focal

# get our current software suite. apt-get is preferred to apt due to warnings
# about a non-stable CLI
run apt-get update

# install the basic apt-utils to limit warnings due to its absence
run DEBIAN_FRONTEND=noninteractive apt-get install --no-install-suggests apt-utils

# upgrade to the current software suite versions
run DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y

# install the required packages for our execution environment and buildfarm runtime
run DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-suggests \
    g++-9 g++ openjdk-14-jdk-headless
</code></pre></div></div><p>And build it with <code class="language-plaintext highlighter-rouge">docker build -t ubuntu20-java14:latest .</code></p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sending build context to Docker daemon   2.56kB
Step 1/5 : from ubuntu:focal
 ---&gt; 9140108b62dc

...

Removing intermediate container 505236be00e4
 ---&gt; 77a8c2ae4d16
Successfully built 77a8c2ae4d16
Successfully tagged ubuntu20-java14:latest
</code></pre></div></div><p>In our example’s case, we want to use this image as a base to build a buildfarm worker container image. Unfortunately, rules_docker does not know how to interact with the <code class="language-plaintext highlighter-rouge">docker images</code> hosted by a local docker daemon, only docker registries like <code class="language-plaintext highlighter-rouge">dockerhub.io</code>. We will get past this by running the local registry utility container. If you really want to host this base elsewhere, I’ll assume that you know how to translate the host:port references below, and you can skip running your own registry.</p><p>First we need to tag our image so that it gets pushed to our local registry:</p><p><code class="language-plaintext highlighter-rouge">docker tag ubuntu20-java14:latest localhost.localdomain:5000/ubuntu20-java14:latest</code></p><p>Then we can start our registry with a recognizable name for later shutdown:</p><p><code class="language-plaintext highlighter-rouge">docker run -d --rm --name local-registry -p 5000:5000 registry</code></p><p>And push our newly tagged image:</p><p><code class="language-plaintext highlighter-rouge">docker push localhost.localdomain:5000/ubuntu20-java14:latest</code></p><p>Take note of the <code class="language-plaintext highlighter-rouge">sha256:&lt;sha256sum&gt;</code> output that was produced with this command, as we will need to use it to specify our base.</p><p>Now we have a referent docker image that can be identified as a base to apply buildfarm’s worker installation onto. In a suitable location, create a WORKSPACE containing:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

BUILDFARM_EXTERNAL_COMMIT = "04fc2635f5546a4f5dc19dea35bb1fca5569ce24"
BUILDFARM_EXTERNAL_SHA256 = "f45215ef075c8aff230b737ca3bc5ba183c1137787fcbbb10dd407463f76edb6"

http_archive(
    name = "build_buildfarm",
    strip_prefix = "bazel-buildfarm-%s" % BUILDFARM_EXTERNAL_COMMIT,
    sha256 = BUILDFARM_EXTERNAL_SHA256,
    url = "https://github.com/buildfarm/buildfarm/archive/%s.zip" % BUILDFARM_EXTERNAL_COMMIT,
)

load("@build_buildfarm//:deps.bzl", "buildfarm_dependencies")

buildfarm_dependencies()

load("@build_buildfarm//:defs.bzl", "buildfarm_init")

buildfarm_init()

load("@io_bazel_rules_docker//repositories:deps.bzl", container_deps = "deps")

load("@io_bazel_rules_docker//container:container.bzl", "container_pull")

container_deps()

container_pull(
    name = "ubuntu20_java14_image_base",
    digest = "sha256:&lt;sha256sum&gt;",
    registry = "localhost:5000",
    repository = "ubuntu20-java14",
)
</code></pre></div></div><p>Be sure to substitute the <code class="language-plaintext highlighter-rouge">sha256:&lt;sha256sum&gt;</code> with your content from above.</p><p>Next we will create a BUILD file to create our target image. We will use the shard variant here, but the memory worker (with supporting server execution) will work as well. The content of the BUILD file should be:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>load("@io_bazel_rules_docker//java:image.bzl", "java_image")

java_image(
    name = "buildfarm-shard-worker-ubuntu20-java14",
    base = "@ubuntu20_java14_image_base//image",
    deps = ["//src/main/java/build/buildfarm:buildfarm-shard-worker"],
    main_class = "build.buildfarm.worker.shard.Worker",
)
</code></pre></div></div><p>And now that this is in place, we can use the following to build the container and make it available to our local docker daemon:</p><p><code class="language-plaintext highlighter-rouge">bazel run :buildfarm-shard-worker-ubuntu20-java14</code></p><hr><footer><p class="text-small text-grey-dk-100 mb-0"></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/buildfarm/buildfarm/edit/main/_site/docs/architecture/worker-execution-environment.md" id="edit-this-page">Edit on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
